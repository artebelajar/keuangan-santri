<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Keuangan</title>
  </head>
  <body>
    <header>
      <h1>Halo, <span id="username">Pengguna</span>!</h1>
      <a href="/logout/">Logout</a>
      <hr />
    </header>

    <main>
      <h2>Ringkasan Bulan ini (<span id="currentMonthYear"></span>)</h2>
      <div id="summary">
        <p>Pemasukan (Income): <strong id="income"></strong></p>
        <p>Pengeluaran (Outcome): <strong id="outcome"></strong></p>
        <h3>Sisa Saldo (balance): <strong id="balance"></strong></h3>
      </div>
      <hr />
      <h2>Input Transaksi Baru</h2>
      <div id="addMessage"></div>
      <form action="" id="addTransactionForm">
        <label for="nominal">Nominal</label>
        <input
          type="number"
          id="nominal"
          placeholder="Contoh: 500000"
          required
        />
        <br />
        <label for="date">Tanggal:</label>
        <input type="date" id="date" required />
        <br />
        <label for="status">Status:</label>
        <select name="status" id="status" required>
          <option value="income">Income</option>
          <option value="outcome">Outcome</option>
        </select>
        <br />
        <label for="description">Keterangan (Opsional):</label>
        <input
          type="text"
          id="description"
          placeholder="Contoh: Gaji bulan lalu"
        />
        <br />
        <button type="submit">Tambah Transaksi</button>
      </form>

      <h2>Riwayat Transaksi</h2>
      <form action="" id="riwayatForm">
        <label for="riwayatSelect">Tampilkan:</label>
        <select
          name="riwayatSelect"
          id="riwayatSelect"
          onchange="
            riwayat = this.value;
            fetchTransactions(CURRENT_YEAR, CURRENT_MONTH);
          "
        >
          <option value="0">Bulan Ini</option>
          <option value="1">1 Bulan Lalu</option>
          <option value="3">3 Bulan Lalu</option>
        </select>
        <!-- <button type="submit">Tampilkan Riwayat</button> -->
      </form>
      <ul id="transactionList">
        <li>Memuat Data...</li>
      </ul>
    </main>

    <script>
      const usernameSpan = document.getElementById("username");
      const incomeEl = document.getElementById("income");
      const outcomeEl = document.getElementById("outcome");
      const balanceEl = document.getElementById("balance");
      const currentMonthYearEl = document.getElementById("currentMonthYear");
      const addTransactionForm = document.getElementById("addTransactionForm");
      const transactionList = document.getElementById("transactionList");
      const addMessageDiv = document.getElementById("addMessage");
      const riwayatForm = document.getElementById("riwayatForm");
      let riwayat = document.getElementById("riwayatSelect").value; // 0: bulan ini, 1: semua riwayat
      console.log("riwayat awal", riwayat);

      const TODAY = new Date();
      const CURRENT_YEAR = TODAY.getFullYear();
      const CURRENT_MONTH = (TODAY.getMonth() + 1).toString().padStart(2, "0");
      let bulanRiwayat = [];

      const formatRupiah = (number) => {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 2,
        }).format(Number(number) || 0);
      };

      const checkAuth = async () => {
        try {
          const response = await fetch("/api/me", {
            method: "GET",
            credentials: "include",
          });
          if (!response.ok) {
            window.location.href = "/login/";
            return null;
          }
          const json = await response.json().catch(() => ({}));
          const { success, data } = json;
          console.log("checkAuth", json);
          if (success && data) {
            usernameSpan.textContent = data.username;
            return data;
          } else {
            window.location.href = "/login/";
            return null;
          }
        } catch (error) {
          window.location.href = "/login/";
          return null;
        }
      };

      // riwayatForm.addEventListener("submit", (e) => {
      //   e.preventDefault();
      //   riwayat = document.getElementById("riwayatSelect").value;
      //   console.log("riwayat dipilih", riwayat);
      //   // fetchTransactions(CURRENT_YEAR, CURRENT_MONTH);
      // });

      const fetchTransactions = async (year, month) => {
        currentMonthYearEl.textContent = `${month}-${year}`;
        transactionList.innerHTML = "<li>Memuat Data...</li>";

        try {
          // console.log("fetchTransactions dengan riwayat:", riwayat);
          for (let i = 0; i < riwayat; i++) {
            // bulanRiwayat.push({ year, month });
            month = parseInt(month, 10) - 3;
            if (month <= 0) {
              month += 12;
              year -= 1;
            }
            console.log("adjusted to:", year, month);
          }

          if (riwayat == 1) {
            month = parseInt(month, 10) - 1;
            if (month <= 0) {
              month += 12;
              year -= 1;
            }
          }

          const response = await fetch(
            `/api/transactions?year=${year}&month=${month}`
          );

          if (!response.ok) {
            transactionList.innerHTML = "<li>Gagal Memuat Transaksi.</li>";
            return;
          }
          const json = await response.json().catch(() => ({}));
          const { success, data = [], summary = {} } = json;

          if (success) {
            incomeEl.textContent = formatRupiah(summary.totalIncome || 0);
            outcomeEl.textContent = formatRupiah(summary.totalOutcome || 0);
            balanceEl.textContent = formatRupiah(summary.balance || 0);

            transactionList.innerHTML = "";
            if (!data || data.length === 0) {
              transactionList.innerHTML =
                "<li>Belum ada Transaksi di bulan ini.</li>";
            } else {
              data.forEach((t) => {
                const li = document.createElement("li");
                const nominalFormatted = formatRupiah(
                  t.nominal || t.amount || 0
                );
                const color =
                  (t.status || "").toLowerCase() === "income" ? "green" : "red";
                const dateStr = t.transactionDate || t.transactionDate || "-";
                li.innerHTML = `<strong>[${(
                  t.status || "-"
                ).toUpperCase()}]</strong> ${dateStr}: <span style="color: ${color};">${nominalFormatted}</span> - ${
                  t.description || "-"
                }`;
                transactionList.appendChild(li);
              });
            }
          } else {
            transactionList.innerHTML = "<li>Gagal Memuat Transaksi.</li>";
          }
          // } else {
          //   console.error("gagal fetchTransactions", error);
          //   transactionList.innerHTML =
          //     "<li>error jaringan saat memuat data</li>";
          // }
        } catch (error) {
          console.error("gagal fetchTransactions", error);
          transactionList.innerHTML =
            "<li>error jaringan saat memuat data</li>";
        }
      };

      addTransactionForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nominal = document.getElementById("nominal").value;
        const transactionsDate = document.getElementById("date").value;
        const status = document.getElementById("status").value;
        const description = document.getElementById("description").value;

        if (!nominal || !transactionsDate || !status) {
          addMessageDiv.style.color = "red";
          addMessageDiv.textContent =
            "Semua field wajib diisi (kecuali keterangan).";
          return;
        }

        try {
          const response = await fetch("/api/transactions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              nominal: parseFloat(nominal),
              transactionsDate,
              status,
              description,
            }),
          });

          const json = await response.json().catch(() => ({}));
          const { success, message } = json;

          if ((response.status === 201 || response.ok) && success) {
            addMessageDiv.style.color = "green";
            addMessageDiv.textContent = "âœ… Transaksi berhasil ditambahkan!";
            addTransactionForm.reset();
            fetchTransactions(CURRENT_YEAR, CURRENT_MONTH);
          } else {
            addMessageDiv.style.color = "red";
            addMessageDiv.textContent = message || "Gagal menambah transaksi.";
          }
        } catch (error) {
          console.error("Gagal menambah transaksi:", error);
          addMessageDiv.style.color = "red";
          addMessageDiv.textContent = "Error jaringan saat menambah transaksi.";
        }
      });

      (async () => {
        const user = await checkAuth();
        if (user) {
          fetchTransactions(CURRENT_YEAR, CURRENT_MONTH);
        }
      })();
    </script>
  </body>
</html>
